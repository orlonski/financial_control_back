name: Auto Dev - Claude Code

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]

jobs:
  planner:
    if: github.event.label.name == 'auto-dev'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Comment - Iniciando An√°lise
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ **Automa√ß√£o iniciada!**\n\nüìã Agente Planejador analisando a tarefa...'
            })

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Run Planner Agent
        id: planner
        run: |
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=30 claude-automation@${{ secrets.SERVER_HOST }} "source ~/crewai-env/bin/activate && cd ~/crewai-agents && python planner_agent.py '${{ github.event.issue.number }}' '${{ github.event.issue.title }}' 'Issue do GitHub'" > plan.txt 2>&1 || true
          cat plan.txt

      - name: Comment - Plano
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('plan.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ü§ñ **Agente Planejador concluiu a an√°lise:**\n\n```\n' + plan + '\n```\n\n---\n‚è≥ **Aguardando aprova√ß√£o.** Comente **"aprovado"** para iniciar o desenvolvimento.'
            })

      - name: Update Label
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                issue_number: ${{ github.event.issue.number }},
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'auto-dev'
              })
            } catch (e) {}
            await github.rest.issues.addLabels({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['aguardando-aprovacao']
            })

  executor:
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.issue.labels.*.name, 'aguardando-aprovacao') &&
      contains(github.event.comment.body, 'aprovado')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Comment - Iniciando Desenvolvimento
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Aprova√ß√£o recebida!**\n\nüë®‚Äçüíª Agente Executor iniciando desenvolvimento...'
            })

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Run Executor Agent
        id: executor
        run: |
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=30 claude-automation@${{ secrets.SERVER_HOST }} "source ~/crewai-env/bin/activate && cd ~/crewai-agents && python executor_agent.py '${{ github.event.issue.number }}' '${{ github.event.issue.title }}' 'Issue do GitHub'" > result.txt 2>&1 || true
          cat result.txt
          PR_URL=$(grep -o 'https://github.com/[^[:space:]]*pull/[0-9]*' result.txt | tail -1 || echo "")
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      - name: Comment - Sucesso
        if: steps.executor.outputs.pr_url != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = fs.readFileSync('result.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üéâ **Desenvolvimento conclu√≠do!**\n\nüîó **Pull Request:** ${{ steps.executor.outputs.pr_url }}\n\n---\n_Deploy autom√°tico ap√≥s o merge._'
            })

      - name: Update Label
        if: steps.executor.outputs.pr_url != ''
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                issue_number: ${{ github.event.issue.number }},
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'aguardando-aprovacao'
              })
            } catch (e) {}
            await github.rest.issues.addLabels({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['em-review']
            })

      - name: Comment - Erro
        if: failure() || steps.executor.outputs.pr_url == ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Erro no desenvolvimento**\n\nVerifique os logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            })
